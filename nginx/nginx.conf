events {}

http {
  # Docker internal DNS for dynamic container IP resolution.
  resolver 127.0.0.11 valid=5s ipv6=off;

  server {
    listen 80;
    client_max_body_size 10M;

    location /media/havati_products/ {
      alias /app/media/havati_products/;
      autoindex off;
    }

    location /media/closet_images/ {
      alias /app/media/closet_images/;
      autoindex off;
    }

    location /api/agents/ {
      set $ai_upstream ai:8001;
      proxy_pass http://$ai_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/embeddings/ {
      set $ai_upstream ai:8001;
      proxy_pass http://$ai_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
      # Use a variable to force runtime DNS lookup of `app`.
      set $django_upstream app:8000;
      proxy_pass http://$django_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
